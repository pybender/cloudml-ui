<h2>
  Import Handler
  <small title="Title"
    class="title" ng-bind="model.name || 'untitled handler'"
    editable="handler" value="handler.name"
    editable-field="name" editable-input="text"
    editable-placement="right"></small>
  <div class="actions" ng-controller="ImportHandlerActionsCtrl">
    <div ng-init="init({handler: handler})">
      <button ng-click="importData(handler)" class="btn btn-info">
        <i title="Load data" class="icon-tasks"></i>
        Import DataSet
      </button>
      <button ng-click="delete(handler)" class="btn btn-danger">
        <i title="Delete your handler. Be careful - you could not recover it!" class="icon-remove"></i>
        Delete
      </button>
    </div>
  </div>
</h2>

<div title="quick info" ng-init="obj=handler">
  <ng-include src="'/partials/parts/created_tags.html'"></ng-include>
</div>
<p></p>

<alert-message ng-show="msg" class="alert-info" msg='{{ msg }}' unsafe></alert-message>
<alert-message ng-show="err" class="alert-error" msg='{{ err }}' unsafe></alert-message>

<ul class="nav nav-tabs" ng-show="handler.loaded">
  <li ng-class="{active: action[0] == 'model'}">
    <a ng-click="setSection(['model', 'details'])">Details</a> 
  </li>
  <li ng-class="{active: action[0] == 'dataset'}"><a ng-click="setSection(['dataset', 'list'])">DataSets</a></li>
</ul>
 
<div class="tab-content" ng-show="handler.loaded">
  <div ng-show="action[0] == 'model'">
  <p class="switcher">
    <b>Switch View: </b>
    <a ng-class="{active: action[1] == 'details'}" ng-click="setSection(['model', 'details'])">Standart</a> | 
    <a ng-class="{active: action[1] == 'json'}" ng-click="setSection(['model', 'json']);handler.data = handler.getJsonData()">JSON File</a>
  </p>
  <div ng-show="action[1] == 'details'">
    <div>
      Target Schema:
      <span title="Target Schema" class="target_schema" ng-bind="handler.target_schema || 'untitled target schema'" editable="handler" value="handler.target_schema"    editable-field="target_schema" editable-input="text" editable-placement="right"></span>
    </div>
    <div>
        Import Parameters: <span class="value" ng-repeat="param in handler.import_params">{{ param }}</span>
    </div>
    <div>
      <h4>
          Data Sources
      </h4>
      <div class="well" ng-repeat="ds in handler.datasource">
        <!-- <a style="float: right;" ng-click="deleteDataSource(handler.datasources, ds)">
          <i title="Delete data source" class="icon-remove"></i>
        </a> -->
        <div>
          Name:
          <span class="value">
             {{ ds.name }} <span><a ng-click="editDataSource(handler, ds)">(edit)</a></span>
          </span>
        </div>
        <div>
          Type:
          <span class="value">{{ ds.type }}</span>
        </div>
        <div>
          Vendor:
          <span class="value">{{ ds.db_settings.vendor }}</span>
        </div>
        <div>
          Connection String:
          <span class="value">{{ ds.db_settings.conn }}</span>
        </div>
      </div>
    </div>
    <h4>
      Queries
      <div class="actions">
        <a class="btn btn-info" href="#/importhandlers/{{ handler._id }}/query/add">
          <i class="status-icon icon-plus"></i> Add Query
        </a>
      </div>
    </h4>
    <div class="clearfix"></div>
    <div class="well query" ng-repeat="query in handler.queries">
      <a style="float: right;" ng-click="deleteQuery(handler.queries, query)">
        <i title="Delete query" class="icon-remove"></i>
      </a>
      <div>
        Name:
        <span title="name" class="name" ng-bind="query.name || 'untitled name'" editable="query" value="query.name" editable-field="name" editable-input="text" editable-placement="right"></span>
      </div>
      <div>
        SQL:
        <p><textarea ui-codemirror="{mode: 'text/x-mysql', indentWithTabs: true, smartIndent: true, lineNumbers: true, matchBrackets : true, height: '100px'}" ng-model="query.sql"></textarea></p>
        <button ng-click="query.$save({only: ['sql']})">Save</button>
      </div>
      <div>
        <h5>
          Items
          <div class="actions">
            <a class="btn btn-info" href="#/importhandlers/{{ handler._id }}/query/{{ query.num }}/items/add">
              <i class="status-icon icon-plus"></i> Add Item
            </a>
          </div>
        </h5>
        <table class="table table-hover">
        <thead>
          <tr>
            <th>Source</th>
            <th>Target Features</th>
            <th>Process As</th>
            <th>Required?</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="item in query.items">
            <td>
              <span title="source" class="source" ng-bind="item.source || 'no source'" editable="item" value="item.source" editable-field="source" editable-input="text" editable-placement="right"></span>
            </td>
            <td>
              <ul>
              <li ng-repeat="feature in item.target_features">
                <a ng-click="" title="edit feature">{{ feature.name }}</a>
              </li>
              </ul>
            </td>
            <td>
              <span title="Process strategy" ng-bind="item.process_as" editable="item" value="item.process_as" editable-field="process_as" editable-placement="right" editable-input="select" source="PROCESS_STRATEGIES"></span>
            </td>
            <td>
              <a ng-show="item.is_required" ng-click="makeRequired(item, false)"><i class="icon-ok" title="Make not required" /> yes</a> <a ng-click="makeRequired(item, true)" ng-hide="item.is_required"><i class="icon-remove" title="Make required" /> no</a>
            </td>
            <td>
              <a ng-click="deleteItem(query.items, item)">
                <i title="Delete query item" class="icon-remove"></i>
              </a>
            </td>
          </tr>
        </tbody>
        </table>
      </div>
    </div>
    </div>
    <div ng-show="action[1] == 'json'">
      <file-download text="'Download JSON'" css-class="'btn-info btn'" filename="'handler-' + handler.name + '.json'" data="handler.data"></file-download>
      <textarea name="data" ui-codemirror="{ mode: {name: 'javascript', json: true, readOnly: true} }" ng-model="handler.data"></textarea>
    </div>    
  </div>

  <div ng-show="action[0] == 'dataset'">
    <h3>DataSets</h3>
    <div ng-controller="DatasetListCtrl" ng-init="init(handler)">
      <ng-include src="'/partials/datasets/list.html'"></ng-include>
    </div>
  </div>
</div>